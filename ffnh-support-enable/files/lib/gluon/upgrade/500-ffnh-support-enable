local uci   = require("uci").cursor()
local site  = require("gluon.site_config")

-- Liste der aktuellen Support-Keys aus der site.conf
local support_keys = site.support and site.support.ssh and site.support.ssh.keys or {}

uci:load("gluon-config-mode")
local enabled = uci:get_bool("gluon-config-mode", "support_enabled")
uci:unload("gluon-config-mode")

-- Wenn Support deaktiviert -> nichts tun
if not enabled then
  return
end

print("Synchronizing Freifunk Nordhessen Support SSH Keys…")

-- 1) Datei laden
local file = "/etc/dropbear/authorized_keys"
local f = io.open(file, "r")
local content = f and f:read("*all") or ""
if f then f:close() end

local new_output = {}

-- 2) User-Keys extrahieren
-- User-Keys sind alle Zeilen, die NICHT in den site.conf Support-Keys stehen
local function is_support_key(line)
  for _, k in ipairs(support_keys) do
    if line == k then
      return true
    end
  end
  return false
end

for line in content:gmatch("[^\r\n]+") do
  -- Nur User-Keys behalten
  if not is_support_key(line) then
    new_output[#new_output + 1] = line
  end
end

-- 3) Aktuelle Support-Keys anhängen
for _, key in ipairs(support_keys) do
  new_output[#new_output + 1] = key
end

-- 4) Datei neu schreiben
local w = io.open(file, "w")
w:write(table.concat(new_output, "\n") .. "\n")
w:close()
